# Тест: Алгоритм решения судоку 9x9

class Sudoku is
  # Сетка 9x9 (81 клетка) - используем массив
  var grid : Array[Integer](81)

  # Инициализация тестовой сетки
  method init() is
    # Инициализируем все клетки нулями
    var i : Integer()
    i := 0
    while i.Less(81) loop
      grid.set(i, 0)
      i := i.Plus(1)
    end
    
    # Устанавливаем начальные значения
    # Строка 0: 0,8,5,0,0,0,0,0,1
    grid.set(0, 0)
    grid.set(1, 8)
    grid.set(2, 5)
    grid.set(3, 0)
    grid.set(4, 0)
    grid.set(5, 0)
    grid.set(6, 0)
    grid.set(7, 0)
    grid.set(8, 1)
    
    # Строка 1: 1,7,0,0,6,4,8,0,0
    grid.set(9, 1)
    grid.set(10, 7)
    grid.set(11, 0)
    grid.set(12, 0)
    grid.set(13, 6)
    grid.set(14, 4)
    grid.set(15, 8)
    grid.set(16, 0)
    grid.set(17, 0)
    
    # Строка 2: 0,0,9,1,0,0,3,7,2
    grid.set(18, 0)
    grid.set(19, 0)
    grid.set(20, 9)
    grid.set(21, 1)
    grid.set(22, 0)
    grid.set(23, 0)
    grid.set(24, 3)
    grid.set(25, 7)
    grid.set(26, 2)
    
    # Строка 3: 6,2,1,0,5,0,7,3,0
    grid.set(27, 6)
    grid.set(28, 2)
    grid.set(29, 1)
    grid.set(30, 0)
    grid.set(31, 5)
    grid.set(32, 0)
    grid.set(33, 7)
    grid.set(34, 3)
    grid.set(35, 0)
    
    # Строка 4: 8,0,0,7,0,0,1,6,9
    grid.set(36, 8)
    grid.set(37, 0)
    grid.set(38, 0)
    grid.set(39, 7)
    grid.set(40, 0)
    grid.set(41, 0)
    grid.set(42, 1)
    grid.set(43, 6)
    grid.set(44, 9)
    
    # Строка 5: 0,0,7,6,1,0,0,0,0
    grid.set(45, 0)
    grid.set(46, 0)
    grid.set(47, 7)
    grid.set(48, 6)
    grid.set(49, 1)
    grid.set(50, 0)
    grid.set(51, 0)
    grid.set(52, 0)
    grid.set(53, 0)
    
    # Строка 6: 0,1,0,0,0,9,5,0,7
    grid.set(54, 0)
    grid.set(55, 1)
    grid.set(56, 0)
    grid.set(57, 0)
    grid.set(58, 0)
    grid.set(59, 9)
    grid.set(60, 5)
    grid.set(61, 0)
    grid.set(62, 7)
    
    # Строка 7: 7,0,0,0,2,6,0,1,3
    grid.set(63, 7)
    grid.set(64, 0)
    grid.set(65, 0)
    grid.set(66, 0)
    grid.set(67, 2)
    grid.set(68, 6)
    grid.set(69, 0)
    grid.set(70, 1)
    grid.set(71, 3)
    
    # Строка 8: 0,3,4,8,0,1,0,0,0
    grid.set(72, 0)
    grid.set(73, 3)
    grid.set(74, 4)
    grid.set(75, 8)
    grid.set(76, 0)
    grid.set(77, 1)
    grid.set(78, 0)
    grid.set(79, 0)
    grid.set(80, 0)
  end

  # Получить значение клетки по координатам (row, col)
  method getCell(row: Integer, col: Integer) : Integer is
    var idx : Integer()
    idx := row.Mult(9).Plus(col)
    return grid.get(idx)
  end

  # Установить значение клетки по координатам (row, col)
  method setCell(row: Integer, col: Integer, num: Integer) is
    var idx : Integer()
    idx := row.Mult(9).Plus(col)
    grid.set(idx, num)
  end

  # Проверка, можно ли поставить число d в клетку (r, c)
  method canPlace(r: Integer, c: Integer, d: Integer) : Bool is
    var i : Integer()
    
    # Проверка строки: перебираем все столбцы
    i := 0
    while i.Less(9) loop
      if i.NotEqual(c) then
        if this.getCell(r, i).Equal(d) then
          return false
        end
      end
      i := i.Plus(1)
    end
    
    # Проверка столбца: перебираем все строки
    i := 0
    while i.Less(9) loop
      if i.NotEqual(r) then
        if this.getCell(i, c).Equal(d) then
          return false
        end
      end
      i := i.Plus(1)
    end
    
    # Проверка блока 3x3
    var br : Integer()
    var bc : Integer()
    var j : Integer()
    
    # br = 3 * (r // 3), bc = 3 * (c // 3)
    if r.Less(3) then
      br := 0
    else
      if r.Less(6) then
        br := 3
      else
        br := 6
      end
    end
    
    if c.Less(3) then
      bc := 0
    else
      if c.Less(6) then
        bc := 3
      else
        bc := 6
      end
    end
    
    # Перебираем все клетки в блоке 3x3
    i := br
    while i.Less(br.Plus(3)) loop
      j := bc
      while j.Less(bc.Plus(3)) loop
        if i.NotEqual(r) then
          if this.getCell(i, j).Equal(d) then
            return false
          end
        else
          if j.NotEqual(c) then
            if this.getCell(i, j).Equal(d) then
              return false
            end
          end
        end
        j := j.Plus(1)
      end
      i := i.Plus(1)
    end
    
    return true
  end

  # Найти первую пустую клетку (возвращает -1 если не найдена)
  method findEmpty() : Integer is
    var r : Integer()
    var c : Integer()
    
    r := 0
    while r.Less(9) loop
      c := 0
      while c.Less(9) loop
        if this.getCell(r, c).Equal(0) then
          # Возвращаем индекс: r * 9 + c
          return r.Mult(9).Plus(c)
        end
        c := c.Plus(1)
      end
      r := r.Plus(1)
    end
    
    return -1
  end

  # Решение судоку: упрощенный итеративный алгоритм
  method solve() : Bool is
    var r : Integer()
    var c : Integer()
    var d : Integer()
    var cellValue : Integer()
    var found : Bool()
    var iterations : Integer()
    var changed : Bool()
    
    # Повторяем процесс несколько раз до полного заполнения
    iterations := 0
    while iterations.Less(100) loop
      changed := false
      
      # Перебираем все клетки
      r := 0
      while r.Less(9) loop
        c := 0
        while c.Less(9) loop
          cellValue := this.getCell(r, c)
          
          # Если клетка пустая, пытаемся заполнить
          if cellValue.Equal(0) then
            # Пробуем цифры 1..9
            d := 1
            found := false
            while d.Less(10) loop
              if this.canPlace(r, c, d) then
                # Проверяем, что только одно число подходит (упрощение)
                if found.Equal(false) then
                  this.setCell(r, c, d)
                  found := true
                  changed := true
                else
                  # Если несколько чисел подходят, пропускаем
                  found := false
                  this.setCell(r, c, 0)
                  d := 10
                end
              end
              d := d.Plus(1)
            end
          end
          
          c := c.Plus(1)
        end
        r := r.Plus(1)
      end
      
      # Если ничего не изменилось, останавливаемся
      if changed.Equal(false) then
        iterations := 100
      else
        iterations := iterations.Plus(1)
      end
    end
    
    # Проверяем, все ли клетки заполнены
    r := 0
    while r.Less(9) loop
      c := 0
      while c.Less(9) loop
        if this.getCell(r, c).Equal(0) then
          return false
        end
        c := c.Plus(1)
      end
      r := r.Plus(1)
    end
    
    return true
  end

  # Вывод сетки построчно
  method show() is
    var r : Integer()
    var c : Integer()
    var val : Integer()
    
    r := 0
    while r.Less(9) loop
      c := 0
      while c.Less(9) loop
        val := this.getCell(r, c)
        print(val)
        c := c.Plus(1)
      end
      r := r.Plus(1)
    end
  end
end

class Program is
  var sudoku : Sudoku()
  
  method main() is
    sudoku.init()
    print(100)
    sudoku.show()
    
    sudoku.solve()
    print(200)
    sudoku.show()
  end
end
